---
title: 事件循环
date: 2023-03-06 10:15:51
permalink: /pages/9e0642/
categories:
  - 前端
  - js学习笔记
tags:
  - 
author: 
  name: Ling HuanLiang
  link: https://github.com/lilling02
---

# 事件循环

## 浏览器进程模型 
在前面学习浏览器进程时候,我已经知道了浏览器其实进程已经很复杂了.

但是常见的有这么几个:

* 浏览器进程
* 渲染进程
* 插件进程
* 网络进程
* GPU进程
* 音频进程

而要说事件循环就要重浏览器的渲染进程说起.

## 渲染进程
渲染进程启动后,会开启一个渲染主线程,主线程负责执行HTML,CSS,JS代码,并且渲染页面.
默认情况下,浏览器会为每个标签页开启一个新的渲染进程,以保证不通的标签页之间不互相影响.(现在最新似乎是提议是一个站点一个进程而不是一个标签页一个进程,否则会导致内存占用过大)

渲染主线程是浏览器中最繁忙的线程.因为它要解析HTML,CSS,JS,并且要计算页面的布局和绘制页面.每秒都要绘制60帧,这个任务量是非常大的.甚至还要执行全局的JS代码.执行事件处理函数.等等...总之很多事情要做.

 
## 什么是JS异步?
JS是一门单线程的语言,这是因为它运行在浏览器的渲染主线程中,而渲染主线程只有一个>而渲染主线程承担着诸多的工作,渲染页面、执行 JS 都在其中运行.如果使用同步的方式、就极有可能导致主线程产生阻塞,从而导致消息队列中的很多其他任务无法得到执行.这样一来,-I方面会导致繁忙的主线程白白的消耗时间,另一方面导致页面无法及时更新,给用户造成卡死现象.
所以浏览器采用异步的方式来避免.具体做法是当某些任务发生时,比如计时器、网络、事件监听,主线程将任务交给其他线程去处理,自身立即结束任务的执行,转而执行后续代码.当其他线程完成时,将事先传递的回调函数包装成任务,加入到消息队列的末尾排队,等待主线程调度执行.在这种异步模式下,浏览器永不阻塞,从而最大限度的保证了单线程的流畅运行.


## 任务是有优先级的吗?
任务是没有优先级的,在消息队列里面先进先出.
但是消息队列是有优先级的.


根据 W3C的最新解释:
* 每个任务都有一个任务类型,同一个类型的任务必须在一个队列,不同类型的任务可以分属于不同的队列.在一次事件循环中,浏览器可以根据实际情况从不同的队列中取出任务执行.
* 浏览器必须准备好一个微队列,微队列中的任务优先所有其他任务执行
https://html.spec.whatwg.org/multipage/webappapis.html#perform-a-microtask-checkpoint


*** 随着浏览器的复杂度急剧提升,W3C 不再使用宏队列的说法 *** 

在目前 chrome 的实现中,至少包含了下面的队列:
延时队列: 用于存放计时器到达后的回调任务,优先级 中
交互队列:用于存放用户操作后产生的事件处理任务,优先级 高
微队列:用户存放需要最快执行的任务,优先级[最高]


## 事件循环

说到这里其实事件循环我们可以给他下定义了:

参考答案:
事件循环又叫做消息循环,是浏览器渲染主线程的工作方式
在 Chrome 的源码中,它开启一个不会结束的 for 循环,每次循环从消息队列中取出第一个任务执行,而其他线程只需要在合适的时候将任务加入到队列未尾即可.
过去把消息队列简单分为宏队列和微队列,这种说法目前已无法满足复杂的浏览器环境,取而代之的是一种更加灵活多变的处理方式.
根据 W3C官方的解释,每个任务有不同的类型,同类型的任务必须在同一个队列,不同的任务可以属于不同的队列.不同任务队列有不同的优先级,在一次事件循环中,雨浏览器自行决定取哪一个队列的任务.但浏览器必须有一个微队列,微队列的任务一定具有最高的优先级,必须优先调度执行.

## 一道附加面试题: js中的计时器能做到精确计时吗? 为什么?

不行,因为:
* 计算机硬件没有原子钟,无法做到精确计时
* 操作系统的计时函数本身就有少量偏差,由于定时器最终调用的是操作系统的函数,也就携带了这
些偏差
* 按照 W3C的标准,浏览器实现计时器时,如果嵌套层级超过 5层,则会带有 4 毫秒的最少时间,这样在计时时间少于4毫秒时又带来了偏差
* 受事件循环的影响,计时器的回调函数只能在主线程空闲时运行,因此又带来了偏差





单线程是异步产生的原因.

事件循环是异步的实现方式.



<!-- q:新版本chrome 消息队列已经分三个队列了吗? -->